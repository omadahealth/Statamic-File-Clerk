$(function(){var a={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("change",".file-upload",this.uploadFiles),$("body").on("click",".btn-remove",this.removeFileReference),$("body").on("click",".load_existing",this.loadExisting),$("body").on("doubletap",".is-directory",this.loadExisting),$("body").on("click",".breadcrumb a, .error-no-results a[data-uri]",this.loadExisting),$("body").on("tap",".view-list td",this.highlightRow),$("body").on("click",'[data-action="select_file"]',this.selectFile),$("body").on("click",'[data-action="go-back"]',this.goBack)},prepareUpload:function(a){var b=a.target.files,c=$(this).closest(".fileclerk").find(".btn-upload");c.removeClass("is-hidden"),console.log(b)},fileCheck:function(a,b){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:a,filename:b},cache:!1,dataType:"JSON",processData:!0,contentType:!1,beforeSend:function(){},success:function(a){return console.log(a),a.error},error:function(){return!1}})},uploadFiles:function(b){b.preventDefault();var c=$(this),d=c.closest(".fileclerk"),e=c.val(),f=e.split("\\"),g=f[f.length-1],h=c.closest(".view-upload"),i=h.find(".postUrl").val(),j=h.find(".postUrl").data("destination"),k=h.find(".file-wrapper"),l=h.find(".progress-bar"),m=l.find("progress"),n=l.find(".prc"),o=d.find(".result .filename-display .filename"),p=d.find(".result input.successful-upload"),q=d.find(".result"),r=d,s=d.find(".add-file"),t=s.find(".nav-tabs li:nth-child(2) a"),u=d.find(".upload-error"),v=d.find(".preview"),w=d.find(".result input.hidden-url"),x=d.find(".result input.hidden-filename"),y=d.find(".result input.hidden-extension"),z=d.find(".result input.hidden-size"),A=d.find(".result input.hidden-size-bytes"),B=d.find(".result input.hidden-size-kilobytes"),C=d.find(".result input.hidden-size-megabytes"),D=d.find(".result input.hidden-size-gigabytes"),E=d.find(".result input.hidden-mime-type"),F=d.find(".result input.hidden-is-image");if(""!==g){var G=new FormData;$.each(c[0].files,function(a,b){G.append("file-"+a,b)});var H=function(a){"undefined"!=typeof a&&(i=i+"&overwrite="+a),$.ajax({url:i,type:"POST",data:G,cache:!1,dataType:"JSON",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload.onprogress=function(a){var b=parseInt(a.loaded/a.total*100,10);console.log("Uploading: ",a.loaded/a.total*100+"%"),m.attr({value:a.loaded,max:a.total}),n.html(b+"%")},a.upload.onload=function(){console.log("DONE!")},a},processData:!1,contentType:!1,beforeSend:function(){k.removeClass("is-visible").addClass("is-hidden"),l.toggleClass("is-hidden is-visible")},success:function(a){100===a.code?(console.log(a.success),console.log("URL: "+a.data.fullpath),l.toggleClass("is-visible is-hidden"),o.append(a.data.filename),p.val(a.data.fullpath),o.attr("href",a.data.fullpath),s.toggleClass("is-visible is-hidden"),q.toggleClass("is-hidden is-visible"),r.addClass("yay"),v.removeClass("is-hidden").addClass("is-visible"),w.val(a.data.fullpath),x.val(a.data.filename),y.val(a.data.extension),z.val(a.data.size),A.val(a.data.size_bytes),B.val(a.data.size_kilobytes),C.val(a.data.size_megabytes),D.val(a.data.size_gigabytes),F.val(a.data.is_image),E.val(a.data.mime_type)):200===a.code||(300===a.code?(console.log(a.message),u.toggleClass("is-hidden is-visible").html(a.html),l.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");"replace"===b&&(console.log("Replace"),H(!0),u.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),H(!1),u.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),u.toggleClass("is-visible is-hidden"),k.removeClass("is-hidden").addClass("is-visible")),a.preventDefault()})):700===a.code?(console.log(a.message),u.toggleClass("is-hidden is-visible").html(a.html),l.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-not-allowed a").on("click",function(a){var b=$(this).attr("data-action");"cancel"===b&&(console.log("Cancel"),u.toggleClass("is-visible is-hidden"),k.toggleClass("is-hidden is-visible")),a.preventDefault()})):console.log("ERRORS: "+a.error))},error:function(a,b){console.log("ERRORS: "+b)}})},I=function(){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:j,filename:g},cache:!1,dataType:"JSON",processData:!0,contentType:!1,async:!1,beforeSend:function(){},success:function(a){300===a.code?(b.preventDefault(),console.log(a),console.log(a.message),k.toggleClass("is-visible is-hidden"),u.toggleClass("is-hidden is-visible").html(a.html),t.removeAttr("data-toggle").addClass("disabled"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");console.log(b),"replace"===b&&(console.log("Replace"),H(!0),u.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),H(!1),u.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),u.toggleClass("is-visible is-hidden"),k.toggleClass("is-hidden is-visible")),t.attr("data-toggle","tab").removeClass("disabled"),a.preventDefault()})):800===a.code&&H(!1)},error:function(a,b,c){return console.log(c),!1}})};I(),a.resetFormElement(c)}},resetFormElement:function(a){a.wrap("<form>").parent("form").trigger("reset"),a.unwrap()},removeFileReference:function(a){var b=$(this),c=b.closest(".fileclerk"),d=b.closest(".fileclerk").find(".result"),e=b.closest(".fileclerk").find(".add-file"),f=b.closest(".fileclerk").find(".result input.successful-upload"),g=b.closest(".fileclerk").find('.result input[type="hidden"]'),h=b.closest(".fileclerk").find(".result .filename-display .filename"),i=b.closest(".fileclerk").find(".file-wrapper");a.preventDefault(),f.val(""),g.val(""),h.html(""),d.toggleClass("is-visible is-hidden"),setTimeout(function(){e.toggleClass("is-hidden is-visible"),i.removeClass("is-hidden").addClass("is-visible"),c.removeClass("yay")},300)},loadExisting:function(a){a.preventDefault();var b=$(this),c="/TRIGGER/fileclerk/list"+($(this).data("uri")?"?uri="+$(this).data("uri"):"")+($(this).data("uri")?"&":"?")+($(this).data("destination")?"destination="+$(this).data("destination"):""),d=b.closest(".add-file").find(".view-remote .view-list"),e=d.find("table"),f=d.find("tbody"),g=d.find(".error-no-results"),h=b.closest(".add-file").find(".view-remote .breadcrumb"),i=b.closest(".add-file").find(".view-remote .ajax-spinner"),j=b.closest(".add-file").find(".view-remote .ajax-overlay");$.ajax({url:c,type:"GET",cache:!1,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){i.spin({lines:10,length:6,width:2,radius:6,corners:0,hwaccel:!0,top:"165px"}),j.toggleClass("is-hidden is-visible")},success:function(a){400===a.code||a.error===!1?(console.log(a.success),g.remove(),h.html(a.breadcrumb),e.removeClass("is-hidden"),f.html(a.html),i.spin(!1),j.toggleClass("is-visible is-hidden")):500===a.code?(h.html(a.breadcrumb),g.remove(),$(a.html).prependTo(d),e.addClass("is-hidden"),f.empty(),i.spin(!1),j.toggleClass("is-visible is-hidden")):600===a.code},error:function(a,b){console.log("ERRORS: "+b)}})},highlightRow:function(){var a=$(this),b="is-highlighted",c=a.closest("tr").siblings(),d=a.parent("tr"),e=a.closest("tbody").find("tr"),f=a.closest(".view-remote").find('button[data-action="select_file"]');c.removeClass(b),d.toggleClass(b),e.hasClass(b)&&!d.hasClass("directory")?f.prop("disabled",!1):f.prop("disabled",!0)},selectFile:function(a){a.preventDefault();var b=$(this),c=b.closest(".fileclerk"),d=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("file"),e=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted td.is-file").html(),f=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("extension"),g=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("size"),h=b.closest(".fileclerk").find(".result .filename-display .filename"),i=b.closest(".fileclerk").find(".result input.successful-upload"),j=b.closest(".fileclerk").find(".result"),k=b.closest(".fileclerk").find(".add-file"),l=b.closest(".fileclerk").find(".result input.hidden-url"),m=b.closest(".fileclerk").find(".result input.hidden-filename"),n=b.closest(".fileclerk").find(".result input.hidden-extension"),o=b.closest(".fileclerk").find(".result input.hidden-size");h.append(e),i.val(d),l.val(d),m.val(e),n.val(f),o.val(g),h.attr("href",d),k.toggleClass("is-visible is-hidden"),j.toggleClass("is-hidden is-visible"),c.addClass("yay"),console.log(e+" selected")},fileExists:function(a){var b=$(this),c=b.attr("data-action"),d=b.closest(".fileclerk").find(".upload-error"),e=b.closest(".fileclerk").find(".upload-error .error-exists"),f=b.closest(".fileclerk").find(".file-wrapper");"replace"===c&&console.log("Replace"),"keep-both"===c&&console.log("Keep Both"),"cancel"===c&&(console.log("Cancel"),e.remove(),d.toggleClass("is-visible is-hidden"),f.toggleClass("is-hidden is-visible")),a.preventDefault()},goBack:function(a){var b=$(this),c=b.closest(".error-no-results"),d=b.closest(".fileclerk").find(".nav-tabs li:nth-child(1) a").attr("href");$('a[href="'+d+'"]').tab("show"),c.remove(),a.preventDefault()}};a.init();var b=function(a){var b="^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2,4})\\s*(\\d{1,2}):(\\d{1,2})\\s*(am|pm|AM|PM|Am|Pm)$",c=new RegExp(b);if(c.test(a)){var d=c.exec(a).slice(1),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=e+" "+f+" "+g+" "+h+":"+i+":00 "+j;return new Date(k)}return!1},c=function(a){var b=a.split(" "),c=b[0].replace(/,/g,""),d=b[1],e=8;return"KB"===d?e=1024:"MB"===d?e=1048576:"GB"===d&&(e=1073741824),parseInt(c*e,10)};$(".tablesort").stupidtable({date:function(a,c){var d=b(a),e=b(c);return d-e},size:function(a,b){var d=c(a),e=c(b);return d-e}});var d={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("click",'.fileclerk a[rel="inline"]',this.showInlinePreview),$("body").on("click",".fileclerk .inline-preview .modal-close",this.hideInlinePreview)},showInlinePreview:function(a){var b=$(this),c=b.closest(".fileclerk"),d=c.find(".inline-preview"),e=$(".fileclerk .inline-preview"),f=c.find(".inline-preview .load"),g=c.find(".preview").attr("href");e.removeClass("is-visible").addClass("is-hidden"),d.toggleClass("is-hidden is-visible"),f.load(g),a.preventDefault(),a.stopPropagation()},hideInlinePreview:function(a){var b=$(this),c=b.closest(".fileclerk"),d=c.find(".inline-preview");d.toggleClass("is-visible is-hidden"),a.preventDefault(),a.stopPropagation()}};d.init();var e=$('.fileclerk a[rel="external"]');e.on("click",function(a){a.preventDefault(),a.stopPropagation(),window.open(this.href,"_blank")})});