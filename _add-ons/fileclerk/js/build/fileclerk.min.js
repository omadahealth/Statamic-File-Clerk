$(function(){var a={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("change",".file-upload",this.uploadFiles),$("body").on("click",".btn-remove",this.removeFileReference),$("body").on("click",".load_existing",this.loadExisting),$("body").on("doubletap",".is-directory",this.loadExisting),$("body").on("click",".breadcrumb a, .error-no-results a[data-uri]",this.loadExisting),$("body").on("tap",".view-list td",this.highlightRow),$("body").on("click",'[data-action="select_file"]',this.selectFile),$("body").on("click",'[data-action="go-back"]',this.goBack)},prepareUpload:function(a){var b=a.target.files,c=$(this).closest(".fileclerk").find(".btn-upload");c.removeClass("is-hidden"),console.log(b)},fileCheck:function(a,b){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:a,filename:b},cache:!1,dataType:"JSON",processData:!0,contentType:!1,beforeSend:function(){},success:function(a){return console.log(a),a.error},error:function(){return!1}})},uploadFiles:function(b){b.preventDefault();var c=$(this),d=c.val(),e=d.split("\\"),f=e[e.length-1],g=c.closest(".view-upload"),h=g.find(".postUrl").val(),i=g.find(".postUrl").data("destination"),j=g.find(".file-wrapper"),k=g.find(".progress-bar"),l=k.find("progress"),m=k.find(".prc"),n=c.closest(".fileclerk").find(".result .filename-display a"),o=c.closest(".fileclerk").find(".result input.successful-upload"),p=c.closest(".fileclerk").find(".result"),q=c.closest(".fileclerk"),r=c.closest(".fileclerk").find(".add-file"),s=r.find(".nav-tabs li:nth-child(2) a"),t=c.closest(".fileclerk").find(".upload-error"),u=c.closest(".fileclerk").find(".result input.hidden-url"),v=c.closest(".fileclerk").find(".result input.hidden-filename"),w=c.closest(".fileclerk").find(".result input.hidden-extension"),x=c.closest(".fileclerk").find(".result input.hidden-size");if(""!==f){var y=new FormData;$.each(c[0].files,function(a,b){y.append("file-"+a,b)});var z=function(a){"undefined"!=typeof a&&(h=h+"&overwrite="+a),$.ajax({url:h,type:"POST",data:y,cache:!1,dataType:"JSON",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload.onprogress=function(a){var b=parseInt(a.loaded/a.total*100,10);console.log("Uploading: ",a.loaded/a.total*100+"%"),l.attr({value:a.loaded,max:a.total}),m.html(b+"%")},a.upload.onload=function(){console.log("DONE!")},a},processData:!1,contentType:!1,beforeSend:function(){j.removeClass("is-visible").addClass("is-hidden"),k.toggleClass("is-hidden is-visible")},success:function(a){100===a.code?(console.log(a.success),console.log("URL: "+a.data.fullpath),k.toggleClass("is-visible is-hidden"),n.append(a.data.filename),o.val(a.data.fullpath),n.attr("href",a.data.fullpath),r.toggleClass("is-visible is-hidden"),p.toggleClass("is-hidden is-visible"),q.addClass("yay"),u.val(a.data.fullpath),v.val(a.data.filename),w.val(a.data.filetype),x.val(a.data.filesize)):200===a.code||(300===a.code?(console.log(a.message),t.toggleClass("is-hidden is-visible").html(a.html),k.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");"replace"===b&&(console.log("Replace"),z(!0),t.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),z(!1),t.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),j.removeClass("is-hidden").addClass("is-visible")),a.preventDefault()})):700===a.code?(console.log(a.message),t.toggleClass("is-hidden is-visible").html(a.html),k.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-not-allowed a").on("click",function(a){var b=$(this).attr("data-action");"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),j.toggleClass("is-hidden is-visible")),a.preventDefault()})):console.log("ERRORS: "+a.error))},error:function(a,b){console.log("ERRORS: "+b)}})},A=function(){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:i,filename:f},cache:!1,dataType:"JSON",processData:!0,contentType:!1,async:!1,beforeSend:function(){},success:function(a){300===a.code?(b.preventDefault(),console.log(a),console.log(a.message),j.toggleClass("is-visible is-hidden"),t.toggleClass("is-hidden is-visible").html(a.html),s.removeAttr("data-toggle").addClass("disabled"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");console.log(b),"replace"===b&&(console.log("Replace"),z(!0),t.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),z(!1),t.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),j.toggleClass("is-hidden is-visible")),s.attr("data-toggle","tab").removeClass("disabled"),a.preventDefault()})):800===a.code&&z(!1)},error:function(a,b,c){return console.log(c),!1}})};A(),a.resetFormElement(c)}},resetFormElement:function(a){a.wrap("<form>").parent("form").trigger("reset"),a.unwrap()},removeFileReference:function(a){var b=$(this),c=b.closest(".fileclerk"),d=b.closest(".fileclerk").find(".result"),e=b.closest(".fileclerk").find(".add-file"),f=b.closest(".fileclerk").find(".result input.successful-upload"),g=b.closest(".fileclerk").find(".result input.hidden-url"),h=b.closest(".fileclerk").find(".result input.hidden-filename"),i=b.closest(".fileclerk").find(".result input.hidden-extension"),j=b.closest(".fileclerk").find(".result input.hidden-size"),k=b.closest(".fileclerk").find(".result .filename-display a"),l=b.closest(".fileclerk").find(".file-wrapper");a.preventDefault(),f.val(""),g.val(""),h.val(""),i.val(""),j.val(""),k.html(""),d.toggleClass("is-visible is-hidden"),setTimeout(function(){e.toggleClass("is-hidden is-visible"),l.removeClass("is-hidden").addClass("is-visible"),c.removeClass("yay")},300)},loadExisting:function(a){a.preventDefault();var b=$(this),c="/TRIGGER/fileclerk/list"+($(this).data("uri")?"?uri="+$(this).data("uri"):"")+($(this).data("uri")?"&":"?")+($(this).data("destination")?"destination="+$(this).data("destination"):""),d=b.closest(".add-file").find(".view-remote .view-list"),e=d.find("table"),f=d.find("tbody"),g=d.find(".error-no-results"),h=b.closest(".add-file").find(".view-remote .breadcrumb"),i=b.closest(".add-file").find(".view-remote .ajax-spinner"),j=b.closest(".add-file").find(".view-remote .ajax-overlay");$.ajax({url:c,type:"GET",cache:!1,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){i.spin({lines:10,length:6,width:2,radius:6,corners:0,hwaccel:!0,top:"165px"}),j.toggleClass("is-hidden is-visible")},success:function(a){400===a.code||a.error===!1?(console.log(a.success),g.remove(),h.html(a.breadcrumb),e.removeClass("is-hidden"),f.html(a.html),i.spin(!1),j.toggleClass("is-visible is-hidden")):500===a.code?(h.html(a.breadcrumb),g.remove(),$(a.html).prependTo(d),e.addClass("is-hidden"),f.empty(),i.spin(!1),j.toggleClass("is-visible is-hidden")):600===a.code},error:function(a,b){console.log("ERRORS: "+b)}})},highlightRow:function(){var a=$(this),b="is-highlighted",c=a.closest("tr").siblings(),d=a.parent("tr"),e=a.closest("tbody").find("tr"),f=a.closest(".view-remote").find('button[data-action="select_file"]');c.removeClass(b),d.toggleClass(b),e.hasClass(b)&&!d.hasClass("directory")?f.prop("disabled",!1):f.prop("disabled",!0)},selectFile:function(a){a.preventDefault();var b=$(this),c=b.closest(".fileclerk"),d=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("file"),e=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted td.is-file").html(),f=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("extension"),g=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("size"),h=b.closest(".fileclerk").find(".result .filename-display a"),i=b.closest(".fileclerk").find(".result input.successful-upload"),j=b.closest(".fileclerk").find(".result"),k=b.closest(".fileclerk").find(".add-file"),l=b.closest(".fileclerk").find(".result input.hidden-url"),m=b.closest(".fileclerk").find(".result input.hidden-filename"),n=b.closest(".fileclerk").find(".result input.hidden-extension"),o=b.closest(".fileclerk").find(".result input.hidden-size");h.append(e),i.val(d),l.val(d),m.val(e),n.val(f),o.val(g),h.attr("href",d),k.toggleClass("is-visible is-hidden"),j.toggleClass("is-hidden is-visible"),c.addClass("yay"),console.log(e+" selected")},fileExists:function(a){var b=$(this),c=b.attr("data-action"),d=b.closest(".fileclerk").find(".upload-error"),e=b.closest(".fileclerk").find(".upload-error .error-exists"),f=b.closest(".fileclerk").find(".file-wrapper");"replace"===c&&console.log("Replace"),"keep-both"===c&&console.log("Keep Both"),"cancel"===c&&(console.log("Cancel"),e.remove(),d.toggleClass("is-visible is-hidden"),f.toggleClass("is-hidden is-visible")),a.preventDefault()},goBack:function(a){var b=$(this),c=b.closest(".error-no-results"),d=b.closest(".fileclerk").find(".nav-tabs li:nth-child(1) a").attr("href");$('a[href="'+d+'"]').tab("show"),c.remove(),a.preventDefault()}};a.init();var b=function(a){var b="^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2,4})\\s*(\\d{1,2}):(\\d{1,2})\\s*(am|pm|AM|PM|Am|Pm)$",c=new RegExp(b);if(c.test(a)){var d=c.exec(a).slice(1),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=e+" "+f+" "+g+" "+h+":"+i+":00 "+j;return new Date(k)}return!1},c=function(a){var b=a.split(" "),c=b[0].replace(/,/g,""),d=b[1],e=8;return"KB"===d?e=1024:"MB"===d?e=1048576:"GB"===d&&(e=1073741824),parseInt(c*e,10)};$(".tablesort").stupidtable({date:function(a,c){var d=b(a),e=b(c);return d-e},size:function(a,b){var d=c(a),e=c(b);return d-e}});var d=$('a[rel="external"]');d.on("click",function(a){a.preventDefault(),a.stopPropagation(),window.open(this.href,"_blank")})});