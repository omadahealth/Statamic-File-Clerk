$(function(){var a={lines:13,length:6,width:2,radius:6,corners:1,hwaccel:!0},b={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("change",".file-upload",this.uploadFiles),$("body").on("click",".btn-remove",this.removeFileReference),$("body").on("click",".load_existing",this.loadExisting),$("body").on("doubletap",".is-directory",this.loadExisting),$("body").on("click",".breadcrumb a, .error-no-results a[data-uri]",this.loadExisting),$("body").on("tap",".view-list td",this.highlightRow),$("body").on("click",'[data-action="select_file"]',this.selectFile),$("body").on("click",'[data-action="go-back"]',this.goBack)},prepareUpload:function(a){var b=a.target.files,c=$(this).closest(".fileclerk").find(".btn-upload");c.removeClass("is-hidden"),console.log(b)},fileCheck:function(a,b){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:a,filename:b},cache:!1,dataType:"JSON",processData:!0,contentType:!1,beforeSend:function(){},success:function(a){if(700===a.code);else if(300===a.code)return console.log(a),a.error},error:function(){return!1}})},uploadFiles:function(a){a.preventDefault();var c=$(this),d=c.closest(".fileclerk"),e=c.val(),f=e.split("\\"),g=f[f.length-1],h=c.closest(".view-upload"),i=h.find(".postUrl").val(),j=h.find(".postUrl").data("destination"),k=h.find(".file-wrapper"),l=h.find(".progress-bar"),m=l.find("progress"),n=l.find(".prc"),o=d.find(".result .filename-display .filename"),p=d.find(".result input.successful-upload"),q=d.find(".result"),r=d.find(".add-file"),s=r.find(".nav-tabs li:nth-child(2) a"),t=d.find(".upload-error"),u=d.find(".preview"),v=d.find(".inline-preview .load img"),w=d.find(".result input.hidden-url"),x=d.find(".result input.hidden-filename"),y=d.find(".result input.hidden-extension"),z=d.find(".result input.hidden-size"),A=d.find(".result input.hidden-size-bytes"),B=d.find(".result input.hidden-size-kilobytes"),C=d.find(".result input.hidden-size-megabytes"),D=d.find(".result input.hidden-size-gigabytes"),E=d.find(".result input.hidden-is-image");if(""!==g){var F=new FormData;$.each(c[0].files,function(a,b){F.append("file-"+a,b)});var G=function(a){"undefined"!=typeof a&&(i=i+"&overwrite="+a),$.ajax({url:i,type:"POST",data:F,cache:!1,dataType:"JSON",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload.onprogress=function(a){var b=parseInt(a.loaded/a.total*100,10);console.log("Uploading: ",a.loaded/a.total*100+"%"),m.attr({value:a.loaded,max:a.total}),n.html(b+"%")},a.upload.onload=function(){console.log("DONE!")},a},processData:!1,contentType:!1,beforeSend:function(){k.removeClass("is-visible").addClass("is-hidden"),l.toggleClass("is-hidden is-visible")},success:function(a){100===a.code?(console.log(a.success),console.log("URL: "+a.data.fullpath),l.toggleClass("is-visible is-hidden"),o.append(a.data.filename),p.val(a.data.fullpath),o.attr("href",a.data.fullpath),r.toggleClass("is-visible is-hidden"),q.toggleClass("is-hidden is-visible"),d.addClass("yay"),u.removeClass("is-hidden").addClass("is-visible"),w.val(a.data.fullpath),x.val(a.data.filename),y.val(a.data.extension),z.val(a.data.size),A.val(a.data.size_bytes),B.val(a.data.size_kilobytes),C.val(a.data.size_megabytes),D.val(a.data.size_gigabytes),E.val(a.data.is_image),u.attr("href",a.data.fullpath),v.attr("src",""),"true"===E.val()||"1"===E.val()?(u.unbind(),u.attr("rel","inline")):(u.unbind(),u.attr("rel","external"))):200===a.code||(300===a.code?(console.log(a.message),t.toggleClass("is-hidden is-visible").html(a.html),l.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");"replace"===b&&(console.log("Replace"),G(!0),t.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),G(!1),t.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),k.removeClass("is-hidden").addClass("is-visible")),a.preventDefault()})):700===a.code?(console.log(a.message),t.toggleClass("is-hidden is-visible").html(a.html),l.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-not-allowed a").on("click",function(a){var b=$(this).attr("data-action");"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),k.toggleClass("is-hidden is-visible")),a.preventDefault()})):console.log("ERRORS: "+a.error))},error:function(a,b){console.log("ERRORS: "+b)}})},H=function(){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:j,filename:g},cache:!1,dataType:"JSON",processData:!0,contentType:!1,async:!1,beforeSend:function(){},success:function(b){300===b.code?(a.preventDefault(),console.log(b),console.log(b.message),k.toggleClass("is-visible is-hidden"),t.toggleClass("is-hidden is-visible").html(b.html),s.removeAttr("data-toggle").addClass("disabled"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");console.log(b),"replace"===b&&(console.log("Replace"),G(!0),t.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),G(!1),t.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),k.toggleClass("is-hidden is-visible")),s.attr("data-toggle","tab").removeClass("disabled"),a.preventDefault()})):700===b.code?(console.log(b.message),k.removeClass("is-visible").addClass("is-hidden"),t.toggleClass("is-hidden is-visible").html(b.html),c.closest(".fileclerk").find(".upload-error .error-not-allowed a").on("click",function(a){var b=$(this).attr("data-action");"cancel"===b&&(console.log("Cancel"),t.toggleClass("is-visible is-hidden"),k.toggleClass("is-hidden is-visible")),a.preventDefault()})):800===b.code&&G(!1)},error:function(a,b,c){return console.log(c),!1}})};H(),b.resetFormElement(c)}},resetFormElement:function(a){a.wrap("<form>").parent("form").trigger("reset"),a.unwrap()},removeFileReference:function(a){var b=$(this),c=b.closest(".fileclerk"),d=b.closest(".fileclerk").find(".result"),e=b.closest(".fileclerk").find(".add-file"),f=b.closest(".fileclerk").find(".result input.successful-upload"),g=b.closest(".fileclerk").find('.result input[type="hidden"]'),h=b.closest(".fileclerk").find(".result .filename-display .filename"),i=b.closest(".fileclerk").find(".file-wrapper");a.preventDefault(),f.val(""),g.val(""),h.html(""),d.toggleClass("is-visible is-hidden"),setTimeout(function(){e.toggleClass("is-hidden is-visible"),i.removeClass("is-hidden").addClass("is-visible"),c.removeClass("yay")},300)},loadExisting:function(b){b.preventDefault();var c=$(this),d="/TRIGGER/fileclerk/list"+($(this).data("uri")?"?uri="+$(this).data("uri"):"")+($(this).data("uri")?"&":"?")+($(this).data("destination")?"destination="+$(this).data("destination"):""),e=c.closest(".add-file").find(".view-remote .view-list"),f=e.find("table"),g=e.find("tbody"),h=e.find(".error-no-results"),i=c.closest(".add-file").find(".view-remote .breadcrumb"),j=c.closest(".add-file").find(".view-remote .ajax-spinner"),k=c.closest(".add-file").find(".view-remote .ajax-overlay");$.ajax({url:d,type:"GET",cache:!1,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){j.spin(a),k.toggleClass("is-hidden is-visible")},success:function(a){400===a.code||a.error===!1?(console.log(a.success),h.remove(),i.html(a.breadcrumb),f.removeClass("is-hidden"),g.html(a.html),j.spin(!1),k.toggleClass("is-visible is-hidden")):500===a.code?(i.html(a.breadcrumb),h.remove(),$(a.html).prependTo(e),f.addClass("is-hidden"),g.empty(),j.spin(!1),k.toggleClass("is-visible is-hidden")):600===a.code},error:function(a,b){console.log("ERRORS: "+b)}})},highlightRow:function(){var a=$(this),b="is-highlighted",c=a.closest("tr").siblings(),d=a.parent("tr"),e=a.closest("tbody").find("tr"),f=a.closest(".view-remote").find('button[data-action="select_file"]');c.removeClass(b),d.toggleClass(b),e.hasClass(b)&&!d.hasClass("directory")?f.prop("disabled",!1):f.prop("disabled",!0)},selectFile:function(a){a.preventDefault();var b=$(this),c=b.closest(".fileclerk"),d=b.closest(".view-remote"),e=d.find(".view-list table tr.file.is-highlighted").data("file"),f=d.find(".view-list table tr.file.is-highlighted td.is-file").html(),g=d.find(".view-list table tr.file.is-highlighted").data("extension"),h=d.find(".view-list table tr.file.is-highlighted").data("is-image"),i=d.find(".view-list table tr.file.is-highlighted").data("size"),j=d.find(".view-list table tr.file.is-highlighted").data("size-bytes"),k=d.find(".view-list table tr.file.is-highlighted").data("size-kilobytes"),l=d.find(".view-list table tr.file.is-highlighted").data("size-megabytes"),m=d.find(".view-list table tr.file.is-highlighted").data("size-gigabytes"),n=c.find(".result .filename-display .filename"),o=c.find(".result input.successful-upload"),p=c.find(".result"),q=c.find(".add-file"),r=c.find(".preview"),s=c.find(".inline-preview .load img"),t=c.find(".result input.hidden-url"),u=c.find(".result input.hidden-filename"),v=c.find(".result input.hidden-extension"),w=c.find(".result input.hidden-size"),x=c.find(".result input.hidden-size-bytes"),y=c.find(".result input.hidden-size-kilobytes"),z=c.find(".result input.hidden-size-megabytes"),A=c.find(".result input.hidden-size-gigabytes"),B=c.find(".result input.hidden-is-image");n.append(f),o.val(e),t.val(e),u.val(f),v.val(g),B.val(h),w.val(i),x.val(j),y.val(k),z.val(l),A.val(m),n.attr("href",e),r.removeClass("is-hidden").addClass("is-visible"),q.toggleClass("is-visible is-hidden"),p.toggleClass("is-hidden is-visible"),c.addClass("yay"),r.attr("href",e),s.attr("src",""),"true"===B.val()||"1"===B.val()?(r.unbind(),r.attr("rel","inline")):(r.unbind(),r.attr("rel","external")),console.log(f+" selected")},fileExists:function(a){var b=$(this),c=b.attr("data-action"),d=b.closest(".fileclerk").find(".upload-error"),e=b.closest(".fileclerk").find(".upload-error .error-exists"),f=b.closest(".fileclerk").find(".file-wrapper");"replace"===c&&console.log("Replace"),"keep-both"===c&&console.log("Keep Both"),"cancel"===c&&(console.log("Cancel"),e.remove(),d.toggleClass("is-visible is-hidden"),f.toggleClass("is-hidden is-visible")),a.preventDefault()},goBack:function(a){var b=$(this),c=b.closest(".error-no-results"),d=b.closest(".fileclerk").find(".nav-tabs li:nth-child(1) a").attr("href");$('a[href="'+d+'"]').tab("show"),c.remove(),a.preventDefault()}};b.init();var c=function(a){var b="^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2,4})\\s*(\\d{1,2}):(\\d{1,2})\\s*(am|pm|AM|PM|Am|Pm)$",c=new RegExp(b);if(c.test(a)){var d=c.exec(a).slice(1),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=e+" "+f+" "+g+" "+h+":"+i+":00 "+j;return new Date(k)}return!1},d=function(a){var b=a.split(" "),c=b[0].replace(/,/g,""),d=b[1],e=8;return"KB"===d?e=1024:"MB"===d?e=1048576:"GB"===d&&(e=1073741824),parseInt(c*e,10)};$(".tablesort").stupidtable({date:function(a,b){var d=c(a),e=c(b);return d-e},size:function(a,b){var c=d(a),e=d(b);return c-e}});var e={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("click",'.fileclerk .result a[rel="inline"]',this.showInlinePreview),$("body").on("click",".fileclerk .inline-preview .modal-close",this.hideInlinePreview),$(document).keyup(function(a){if(27===a.keyCode){var b=$(".fileclerk .inline-preview"),c=$(".fileclerk .result .preview");b.removeClass("is-visible").addClass("is-hidden"),c.removeClass("active")}}),$(document).on("click",function(a){if(!$(a.target).closest(".fileclerk .inline-preview").length){var b=$(".fileclerk .inline-preview"),c=$(".fileclerk .result .preview");b.removeClass("is-visible").addClass("is-hidden"),c.removeClass("active")}})},showInlinePreview:function(b){var c=$(this),d=c.closest(".fileclerk"),e=d.find("a.preview").attr("href"),f=d.find(".inline-preview .load img"),g=d.find(".inline-preview"),h=$(".fileclerk .inline-preview"),i=$(".fileclerk .result .preview"),j=d.find(".inline-preview .load .ajax-spinner"),k=$("html, body");h.removeClass("is-visible").addClass("is-hidden"),i.removeClass("active"),g.toggleClass("is-hidden is-visible"),c.addClass("active"),k.animate({scrollTop:g.offset().top-20},500),$.ajax({url:"/TRIGGER/fileclerk/ajaxpreview?url="+e,cache:!1,dataType:"JSON",beforeSend:function(){j.spin(a)},success:function(a){f.attr("src",a.url),console.log(a),j.spin(!1)}}),console.log(c.attr("rel")),b.preventDefault(),b.stopPropagation()},hideInlinePreview:function(a){var b=$(this),c=b.closest(".fileclerk"),d=c.find(".inline-preview"),e=c.find(".preview");d.toggleClass("is-visible is-hidden"),e.removeClass("active"),a.preventDefault(),a.stopPropagation()}};e.init();var f={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("click",'.fileclerk a[rel="external"]',this.previewExternal)},previewExternal:function(a){a.preventDefault(),a.stopPropagation(),window.open(this.href,"_blank")}};f.init()});