$(function(){var a={init:function(){this.bindUIActions()},bindUIActions:function(){$("body").on("change",".file-upload",this.uploadFiles),$("body").on("click",".btn-remove",this.removeFileReference),$("body").on("click",".load_existing",this.loadExisting),$("body").on("doubletap",".is-directory",this.loadExisting),$("body").on("click",".breadcrumb a, .error-no-results a",this.loadExisting),$("body").on("tap",".view-list td",this.highlightRow),$("body").on("click",'[data-action="select_file"]',this.selectFile)},prepareUpload:function(a){var b=a.target.files,c=$(this).closest(".fileclerk").find(".btn-upload");c.removeClass("is-hidden"),console.log(b)},fileCheck:function(a,b){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:a,filename:b},cache:!1,dataType:"JSON",processData:!0,contentType:!1,beforeSend:function(){},success:function(a){return console.log(a),a.error},error:function(){return!1}})},uploadFiles:function(b){b.preventDefault();var c=$(this),d=c.val(),e=d.split("\\"),f=e[e.length-1],g=c.closest(".view-upload"),h=g.find(".postUrl").val(),i=g.find(".file-wrapper"),j=g.find(".progress-bar"),k=j.find("progress"),l=j.find(".prc"),m=c.closest(".fileclerk").find(".result .filename-display a"),n=c.closest(".fileclerk").find(".result input.successful-upload"),o=c.closest(".fileclerk").find(".result"),p=c.closest(".fileclerk").find(".add-file"),q=c.closest(".fileclerk").find(".upload-error"),r=c.closest(".fileclerk").find(".result input.hidden-url"),s=c.closest(".fileclerk").find(".result input.hidden-filename"),t=c.closest(".fileclerk").find(".result input.hidden-extension"),u=c.closest(".fileclerk").find(".result input.hidden-size");if(""!==f){var v=new FormData;$.each(c[0].files,function(a,b){v.append("file-"+a,b)});var w=function(a){"undefined"!=typeof a&&(h=h+"&overwrite="+a),$.ajax({url:h,type:"POST",data:v,cache:!1,dataType:"JSON",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&(console.log("Xhr"),a.upload.addEventListener("progress",function(a){if(a.lengthComputable){var b=parseInt(a.loaded/a.total*100,10);console.log(b+"%"),k.attr({value:a.loaded,max:a.total}),l.html(b+"%")}},!1)),a},processData:!1,contentType:!1,beforeSend:function(){i.removeClass("is-visible").addClass("is-hidden"),j.toggleClass("is-hidden is-visible")},success:function(a){100===a.code?(console.log(a.success),console.log("URL: "+a.data.fullpath),j.addClass("is-hidden"),m.append(a.data.filename),n.val(a.data.fullpath),m.attr("href",a.data.fullpath),p.toggleClass("is-visible is-hidden"),o.toggleClass("is-hidden is-visible"),r.val(a.data.fullpath),s.val(a.data.filename),t.val(a.data.filetype),u.val(a.data.filesize)):200===a.code||(300===a.code?(console.log(a.message),q.toggleClass("is-hidden is-visible").html(a.html),j.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");"replace"===b&&(console.log("Replace"),w(!0),q.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),w(!1),q.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),q.toggleClass("is-visible is-hidden"),i.toggleClass("is-hidden is-visible")),a.preventDefault()})):700===a.code?(console.log(a.message),q.toggleClass("is-hidden is-visible").html(a.html),j.toggleClass("is-visible is-hidden"),c.closest(".fileclerk").find(".upload-error .error-not-allowed a").on("click",function(a){var b=$(this).attr("data-action");"cancel"===b&&(console.log("Cancel"),q.toggleClass("is-visible is-hidden"),i.toggleClass("is-hidden is-visible")),a.preventDefault()})):console.log("ERRORS: "+a.error))},error:function(a,b){console.log("ERRORS: "+b)}})},x=function(){$.ajax({url:"/TRIGGER/fileclerk/filecheck",type:"GET",data:{destination:c.data("destination"),filename:f},cache:!1,dataType:"JSON",processData:!0,contentType:!1,async:!1,beforeSend:function(){},success:function(a){300===a.code?(b.preventDefault(),console.log(a),console.log(a.message),i.toggleClass("is-visible is-hidden"),q.toggleClass("is-hidden is-visible").html(a.html),c.closest(".fileclerk").find(".upload-error .error-exists a").on("click",function(a){var b=$(this).attr("data-action");console.log(b),"replace"===b&&(console.log("Replace"),w(!0),q.toggleClass("is-visible is-hidden")),"keep-both"===b&&(console.log("Keep Both"),w(!1),q.toggleClass("is-visible is-hidden")),"cancel"===b&&(console.log("Cancel"),q.toggleClass("is-visible is-hidden"),i.toggleClass("is-hidden is-visible")),a.preventDefault()})):800===a.code&&w(!1)},error:function(a,b,c){return console.log(c),!1}})};x(),a.resetFormElement(c)}},resetFormElement:function(a){a.wrap("<form>").parent("form").trigger("reset"),a.unwrap()},removeFileReference:function(a){var b=$(this),c=b.closest(".fileclerk").find(".result"),d=b.closest(".fileclerk").find(".add-file"),e=b.closest(".fileclerk").find(".result input.successful-upload"),f=b.closest(".fileclerk").find(".result input.hidden-url"),g=b.closest(".fileclerk").find(".result input.hidden-filename"),h=b.closest(".fileclerk").find(".result input.hidden-extension"),i=b.closest(".fileclerk").find(".result input.hidden-size"),j=b.closest(".fileclerk").find(".result .filename-display a"),k=b.closest(".fileclerk").find(".file-wrapper");a.preventDefault(),e.val(""),f.val(""),g.val(""),h.val(""),i.val(""),j.html(""),c.toggleClass("is-visible is-hidden"),setTimeout(function(){d.toggleClass("is-hidden is-visible"),k.removeClass("is-hidden").addClass("is-visible")},300)},loadExisting:function(a){a.preventDefault();var b=$(this),c="/TRIGGER/fileclerk/list"+($(this).data("uri")?"?uri="+$(this).data("uri"):"")+($(this).data("uri")?"&":"?")+($(this).data("destination")?"destination="+$(this).data("destination"):""),d=b.closest(".add-file").find(".view-remote .view-list"),e=d.find("table"),f=d.find("tbody"),g=d.find(".error-no-results"),h=b.closest(".add-file").find(".view-remote .breadcrumb"),i=b.closest(".add-file").find(".view-remote .ajax-spinner"),j=b.closest(".add-file").find(".view-remote .ajax-overlay");$.ajax({url:c,type:"GET",cache:!1,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){i.spin({lines:10,length:6,width:2,radius:6,corners:0,hwaccel:!0,top:"165px"}),j.toggleClass("is-hidden is-visible")},success:function(a){400===a.code||a.error===!1?(console.log(a.success),g.remove(),h.html(a.breadcrumb),e.removeClass("is-hidden"),f.html(a.html),i.spin(!1),j.toggleClass("is-visible is-hidden")):500===a.code?(h.html(a.breadcrumb),$(a.html).prependTo(d),e.addClass("is-hidden"),f.empty(),i.spin(!1),j.toggleClass("is-visible is-hidden")):600===a.code},error:function(a,b){console.log("ERRORS: "+b)}})},highlightRow:function(){var a=$(this),b="is-highlighted",c=a.closest("tr").siblings(),d=a.parent("tr"),e=a.closest("tbody").find("tr"),f=a.closest(".view-remote").find('button[data-action="select_file"]');c.removeClass(b),d.toggleClass(b),e.hasClass(b)&&!d.hasClass("directory")?f.prop("disabled",!1):f.prop("disabled",!0)},selectFile:function(a){a.preventDefault();var b=$(this),c=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("file"),d=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted td.is-file").html(),e=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("extension"),f=b.closest(".view-remote").find(".view-list table tr.file.is-highlighted").data("size"),g=b.closest(".fileclerk").find(".result .filename-display a"),h=b.closest(".fileclerk").find(".result input.successful-upload"),i=b.closest(".fileclerk").find(".result"),j=b.closest(".fileclerk").find(".add-file"),k=b.closest(".fileclerk").find(".result input.hidden-url"),l=b.closest(".fileclerk").find(".result input.hidden-filename"),m=b.closest(".fileclerk").find(".result input.hidden-extension"),n=b.closest(".fileclerk").find(".result input.hidden-size");g.append(d),h.val(c),k.val(c),l.val(d),m.val(e),n.val(f),g.attr("href",c),j.toggleClass("is-visible is-hidden"),i.toggleClass("is-hidden is-visible"),console.log(d+" selected")},fileExists:function(a){var b=$(this),c=b.attr("data-action"),d=b.closest(".fileclerk").find(".upload-error"),e=b.closest(".fileclerk").find(".upload-error .error-exists"),f=b.closest(".fileclerk").find(".file-wrapper");"replace"===c&&console.log("Replace"),"keep-both"===c&&console.log("Keep Both"),"cancel"===c&&(console.log("Cancel"),e.remove(),d.toggleClass("is-visible is-hidden"),f.toggleClass("is-hidden is-visible")),a.preventDefault()}};a.init();var b=function(a){var b="^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2,4})\\s*(\\d{1,2}):(\\d{1,2})\\s*(am|pm|AM|PM|Am|Pm)$",c=new RegExp(b);if(c.test(a)){var d=c.exec(a).slice(1),e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=e+" "+f+" "+g+" "+h+":"+i+":00 "+j;return new Date(k)}return!1},c=function(a){var b=a.split(" "),c=b[0].replace(/,/g,""),d=b[1],e=8;return"KB"===d?e=1024:"MB"===d?e=1048576:"GB"===d&&(e=1073741824),parseInt(c*e,10)};$(".tablesort").stupidtable({date:function(a,c){var d=b(a),e=b(c);return d-e},size:function(a,b){var d=c(a),e=c(b);return d-e}});var d=$('a[rel="external"]');d.on("click",function(a){a.preventDefault(),a.stopPropagation(),window.open(this.href,"_blank")})});